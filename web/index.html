<!DOCTYPE html>
<html>

<head>
  <title>弑君者游戏</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="css/style.css">

  <style>
    ::-webkit-scrollbar {
      display: none;
    }

    #login-area {
      position: fixed;
      width: 100%;
      height: 100%;
      margin: 0 0;
      top: 0;
      left: 0;
      background-color: rgb(6, 19, 37);
      z-index: 5;
    }

    #login-body {
      width: 400px;
      height: 440px;
      margin: 100px auto;
      background-color: white;
      opacity: 0.8;
      border-radius: 10px;
      text-align: center;
      padding-top: 10px;
      position: relative;
    }

    #load {
      color: rgb(83, 129, 223);
      display: block;
      font-size: 40px;
      margin-top: 10px;
    }

    #login-body span p {
      display: block;
      font-size: 15px;
      text-align: left;
      margin: 10px 40px;
    }

    #login-body span input {
      width: 80%;
      height: 30px;
      border-radius: 5px;
      background-color: rgb(198, 207, 220);
      margin: auto;
      border: 0px;
    }

    #login {
      display: block;
      height: 40px;
      width: 120px;
      background-color: rgb(51, 110, 198);
      color: rgb(255, 255, 255);
      font-size: 20px;
      margin: 30px 40px;
      border-radius: 5px;
      border: 0px;
      transition: 0.1s;
    }

    #alert {
      display: block;
      font-size: 20px;
      font-family: "微软雅黑";
      height: 40px;
      width: 80%;
      padding-top: 12px;
      margin: 10px 40px;
      /* background-color: red; */
      border-radius: 5px;
      opacity: 0;
      /* transform: translateY(20px); */
    }

    #register {
      background-color: grey;
      width: 100%;
      height: 50px;
      font-size: 20px;
      padding-top: 20px;
      position: absolute;
      bottom: 0px;
      border-radius: 0 0 10px 10px;
      color: white;
    }
  </style>
</head>

<body>
  <div id="login-area">
    <div id="login-body">
      <span id="load">加入房间</span>
      <span id="alert"></span>
      <span id="roomname">
        <p>房间名</p><input type="text">
      </span>
      <span id="username">
        <p>昵称</p><input type="text">
      </span>
      <button id="login">加入</button>
      <!-- <div id="register">
        <span>创建房间</span>
      </div> -->
    </div>
  </div>
  <div class="" id="game-board">
    <div class="link">
      <a href="http://47.96.132.249/index.php/2023/11/26/%e5%bc%91%e5%90%9b%e8%80%85%e6%89%91%e5%85%8b%e6%a1%8c%e6%b8%b8%e8%a7%84%e5%88%99/"
        target="_blank">弑君者桌游规则</a>
      <a href="https://github.com/moneypiaorui/regicide">BUG反馈点这里(Github)</a>
    </div>
    <div class="other-players">
      <div class="player-left">
        <span class="player-name">1</span>
        <div class="cardContain" id="player1"></div>
      </div>
      <div class="player-up">
        <span class="player-name">2</span>
        <div class="cardContain" id="player2"></div>
      </div>
      <div class="player-right">
        <span class="player-name">3</span>
        <div class="cardContain" id="player3"></div>
      </div>
    </div>

    <div class="battle-area">
      <div class="attribute"><span id="life">life</span><span id="attack">attack</span></div>
      <div class="piles-area">
        <div class="pile-with-name">
          <span>城堡</span>
          <div class="cardContain" id="bossPile"></div>
        </div>
        <div class="pile-with-name">
          <span>当前BOSS</span>
          <div class="cardContain" id="boss-showArea"></div>
        </div>
        <div class="pile-with-name">
          <span>弃牌堆</span>
          <div class="cardContain" id="wastePile"></div>
        </div>
        <div class="pile-with-name"><span>摸牌区</span>
          <div class="cardContain" id="drawPile"></div>
        </div>
      </div>
    </div>
    <div class="player-area">
      <div class="button-area">
        <div class="button hide" id="play">出牌</div>
        <div class="button hide" id="skip">跳过</div>
        <div class="button hide" id="pay">支付</div>
        <div class="button hide" id="start">开始游戏</div>
      </div>
      <div class="cardContain player-active" id="handPile">

      </div>
    </div>
  </div>


  <script src="js/obj.js"></script>
  <script src="js/functions.js"></script>
  <script>
    al = document.querySelector("#alert");
    showAlert1 = (message) => {
      al.innerText =message;
      al.style.transition = "0s";
      al.style.backgroundColor = "rgba(0, 128, 0,0.4)";
      al.style.color = "green";
      al.style.transform = "translateY(20px)";
      setTimeout(() => {
        al.style.transition = "0.2s";
        al.style.opacity = 1
        al.style.transform = "translateY(0px)";
      }, 1)

      setTimeout(() => {
        al.style.opacity = 0;
        al.style.transform = "translateY(-20px)";
      }, 600)
    }
  </script>
  <script>
    // document.getElementById("game-board").style.display="none";
    playerNum = 0;
    name = "123123";
    roomId = "123"
    clientId = "";
    playerId = 0;

    playButton = document.getElementById("play");
    payButton = document.getElementById("pay");
    skipButton = document.getElementById("skip");
    startButton = document.getElementById("start");
    joinRoomButton = document.getElementById("login");

    handPiles = [];
    bossPile = new CardPile([], "bossPile", 0, 0);
    wastePile = new CardPile([], "wastePile", 1, 1);
    drawPile = new CardPile([], "drawPile", 1, 1);
    Boss = new CardPile([], "boss-showArea", 1, 1);

    function refresh() {
      wastePile.updateShow();
      handPiles.forEach(pile => {
        pile.sort();
        pile.updateShow();
      })
      drawPile.updateShow();
      Boss.updateShow();
      bossPile.updateShow();
      Boss.cardList[0].updateInfo();
    }
    // 创建 WebSocket 对象并指定服务器地址
    var socket = new WebSocket('ws://localhost:8013');


    // 当连接建立时触发的事件
    socket.onopen = function () {
      console.log('WebSocket 连接已建立');
      // 自动加入房间的逻辑
      // socket.send(JSON.stringify({
      //   state: "outRoom",
      //   type: "joinRoom",
      //   roomId: roomId,
      //   name: name
      // }));
    };


    // 当收到服务器发送的消息时触发的事件
    socket.onmessage = function (event) {
      console.log(event.data);
      let data = JSON.parse(event.data);
      // 连接成功，从服务器获得Id
      if (data.type == "connected") {
        if (data.state == "succeed") {
          clientId = data.clientId;
        }
      } else if (data.type == "joinRoom") {
        //加入房间的返回信息
        if (data.state == "fail") {
          alert("加入房间失败\n原因：" + data.message);
        } else if (data.state == "succeed") {
          console.log("成功加入房间\n房间ID:" + roomId);
          showAlert1("加入房间成功");
          setTimeout(() => {
            document.getElementById("login-area").classList.add("hide")
          }, 800)

          // 获得房间玩家信息

          if (data.isHost) {//如果是房主，显示开始游戏按钮
            startButton.classList.remove("hide");
          }

        }
      } else if (data.type == "gameStart") {
        //游戏开始指令，初始化玩家组
        playerNum = data.players.length;
        let players = data.players;
        for (let i = 0; i < playerNum; i++) {
          if (players[i].clientId == clientId) {
            playerId = i + 1;
            break;
          }
        }
        handPiles[playerId - 1] = new CardPile([], "handPile", 1, 0);
        handPiles[playerId - 1].clickAllow = 1;
        for (let i = playerId, tem = 1; tem < playerNum; i++) {
          handPiles[i % playerNum] = new CardPile([], "player" + (tem++), 1, 0)
        }
      } else if (data.type == "updataPiles") {
        //更新排堆状态
        let tem = data.piles.Boss.cardList.map(card => new PokerCard(card.value, card.suit));
        [tem[0].life, tem[0].attack] = [data.piles.Boss.cardList[0].life, data.piles.Boss.cardList[0].attack];
        Boss.push(tem);
        bossPile.push(data.piles.bossPile.cardList.map(card => new PokerCard(card.value, card.suit)));
        drawPile.push(data.piles.drawPile.cardList.map(card => new PokerCard(card.value, card.suit)));
        wastePile.push(data.piles.wastePile.cardList.map(card => new PokerCard(card.value, card.suit)));
        for (let i = 0; i < playerNum; i++) {
          handPiles[i].push(data.piles.handPiles[i].cardList.map(card => new PokerCard(card.value, card.suit)));
        }
        refresh();
      } else if (data.type == "action") {
        if (data.action == "attack") {
          if (data.playerId == playerId) {
            // 让出牌和跳过按钮显示
            playButton.classList.remove("hide");
            skipButton.classList.remove("hide");
          } else {
            // 显示其他人正在出牌
          }
        } else if (data.action == "pay") {
          if (data.playerId == playerId) {
            // 让支付按钮显示
            payButton.classList.remove("hide");
          } else {
            // 显示其他人正在支付
          }
        }
      } else if (data.type == "chatMessage") {

      }
    };

    // 当连接关闭时触发的事件
    socket.onclose = function () {
      console.log('WebSocket 连接已关闭');
    };

    // 当发生错误时触发的事件
    socket.onerror = function (error) {
      console.error('WebSocket 错误：' + error);
    };



    // 判断攻击是否可行
    function attack(attackPile) {
      if (attackPile.length == 1) {
        return 1;
      } else {
        let numClass = countElements(attackPile.map(card => card.value));
        let typeClass = countElements(attackPile.map(card => card.suit));
        let sumAttack = attackPile.reduce((acc, card) => acc + card.attack, 0);
        if (Object.keys(numClass).length == 1 || attackPile.length - numClass["1"] == 1) {
          return 1;
        }
      }
      return 0;
    }

    // 出牌事件
    play = () => {
      if (attack(handPiles[playerId - 1].cardList.filter(card => card.selected == 1))) {
        // 攻击合法向服务器发送指令
        socket.send(JSON.stringify({
          state: "inRoom",
          command: "attack",
          attackPile: handPiles[playerId - 1].cardList.filter(card => card.selected == 1),
          leftPile: handPiles[playerId - 1].cardList.filter(card => card.selected == 0)
        }))
        // 隐藏按钮
        playButton.classList.add("hide");
        skipButton.classList.add("hide");
      } else {
        alert("不允许");
        handPiles[playerId - 1].cardList.forEach(card => {
          if (card.selected) card.select();
        });
      }
    }

    // 支付伤害事件
    pay = () => {
      let selectPile = handPiles[playerId - 1].cardList.filter(card => card.selected == 1)
      let sum = (selectPile.reduce((accumulator, card) => accumulator + card.attack, 0))
      // alert(sum);
      if (sum < Boss.cardList[0].attack) {
        alert("Not enough to defend the attack");
      } else {
        // 支付合法向服务器发送指令
        socket.send(JSON.stringify({
          state: "inRoom",
          command: "pay",
          payPile: handPiles[playerId - 1].cardList.filter(card => card.selected == 1),
          leftPile: handPiles[playerId - 1].cardList.filter(card => card.selected == 0)
        }))
        // 隐藏按钮
        payButton.classList.add("hide");
      }
    }

    skip = () => {

    }

    playButton.addEventListener("click", play);
    payButton.addEventListener("click", pay);
    skipButton.addEventListener("click", skip);

    //加入房间
    joinRoomButton.addEventListener("click", () => {
      document.querySelector("#login").style.backgroundColor = "blue";
      setTimeout(() => {
        document.querySelector("#login").style.backgroundColor = "rgb(51, 110, 198)";
      }, 100)
      roomId = document.querySelector("#roomname input").value;
      name = document.querySelector("#username input").value;
      socket.send(JSON.stringify({
        state: "outRoom",
        type: "joinRoom",
        roomId: roomId,
        name: name
      }));
    })


    // 开始游戏
    startButton.addEventListener("click", () => {
      socket.send(JSON.stringify({
        state: "inRoom",
        roomId: "123",
        type: "startGame",
        // name:name
      }))
      startButton.classList.add("hide");
    })
  </script>

  <!-- <script src="js/game.js"></script> -->
</body>

</html>